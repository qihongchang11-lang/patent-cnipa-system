import streamlit as st
import requests
import os
from dotenv import load_dotenv

# 1. 页面基础配置 (必须是第一个 Streamlit 命令)
st.set_page_config(
    page_title="CNIPA 智能专利撰写系统",
    page_icon="⚖️",
    layout="wide",
    initial_sidebar_state="expanded"
)

# 加载环境变量
load_dotenv()

# 2. 自定义 CSS 美化 (注入灵魂)
st.markdown("""
    <style>
    /* 全局字体优化 */
    .stApp {
        font-family: "Microsoft YaHei", sans-serif;
    }
    /* 主标题样式 */
    .main-title {
        font-size: 2.5rem;
        color: #1E3A8A; /* 深蓝色，专业感 */
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
        padding-top: 1rem;
        border-bottom: 2px solid #E5E7EB;
        padding-bottom: 1rem;
    }
    /* 按钮样式优化 */
    .stButton>button {
        width: 100%;
        border-radius: 8px;
        height: 3.5em;
        font-weight: bold;
        background-color: #2563EB; /* 亮蓝色按钮 */
        color: white;
        border: none;
        transition: all 0.3s;
    }
    .stButton>button:hover {
        background-color: #1D4ED8; /* 悬停变深 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    /* 输入框标题样式 */
    .stMarkdown h3 {
        color: #374151;
        font-size: 1.1rem;
        font-weight: 600;
    }
    /* 隐藏 Streamlit 默认菜单和页脚 */
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}
    </style>
""", unsafe_allow_html=True)

# 3. 侧边栏配置 (控制台)
with st.sidebar:
    st.title("⚙️ 系统控制台")
    st.markdown("---")
    
    # API 状态检测
    api_key = os.getenv("API_KEY")
    if api_key:
        st.success("✅ API 服务已连接")
    else:
        st.error("❌ 未检测到 API 密钥")
        st.warning("请检查 .env 文件")

    st.markdown("###  操作指南")
    st.info(
        """
        **第一步**：填写拟申请的【专利名称】
        
        **第二步**：详细描述【技术领域】和核心创新点
        
        **第三步**：点击【立即生成】按钮
        
        **第四步**：在右侧标签页查看生成的文档
        """
    )
    st.markdown("---")
    st.caption("Version 2.0 | CNIPA AI System")

# 4. 主界面布局
st.markdown('<div class="main-title">⚖️ CNIPA 智能专利生成系统</div>', unsafe_allow_html=True)

# 创建两列布局：左边填标题，右边填领域
col1, col2 = st.columns([2, 3]) # 左2右3比例，给技术领域更多空间

with col1:
    st.markdown("###  1. 专利名称")
    st.caption("简明扼要地概括核心技术点")
    title = st.text_input("专利名称", label_visibility="collapsed", placeholder="例如：一种基于大模型的自动化代码审计方法")

with col2:
    st.markdown("###  2. 技术领域与方案")
    st.caption("请描述该专利所属领域及核心技术方案")
    tech_field = st.text_area("技术领域", label_visibility="collapsed", height=150, placeholder="例如：本发明涉及人工智能与网络安全技术领域，特别是一种利用LLM进行静态代码分析的自动化系统...")

# 5. 生成按钮逻辑
st.markdown("###") # 占位空行
generate_btn = st.button(" 立即开始生成专利文档", type="primary")

# 后端 API 地址
API_URL = os.getenv("PUBLIC_API_BASE_URL", "http://api:8000")

if generate_btn:
    if not title or not tech_field:
        st.warning("⚠️ 请先补全【专利名称】和【技术领域】再开始生成。")
    else:
        # 显示加载动画
        with st.spinner(' AI 正在深度思考架构、阅读交底书并撰写文档，请稍候...'):
            try:
                # 构造请求数据
                payload = {
                    "title": title,
                    "technical_field": tech_field,
                    "background": "",
                    "embodiments": "",
                    "claims": ""
                }
                
                # 发送请求给后端
                response = requests.post(f"{API_URL}/generate_patent", json=payload, timeout=120)
                
                if response.status_code == 200:
                    result = response.json()
                    
                    st.success(" 撰写成功！文档已生成完毕，请查看下方详情。")
                    st.markdown("---")
                    
                    # 6. 结果展示区 (使用标签页 Tab 布局)
                    tab1, tab2, tab3 = st.tabs([" 发明内容 (核心)", " 背景技术", " 具体实施方式"])
                    
                    # 辅助函数：显示带复制按钮的文本框
                    def show_result_area(content, height=500):
                        st.text_area("内容预览", value=content, height=height, label_visibility="collapsed")

                    with tab1:
                        st.markdown("#### 核心发明点摘要")
                        show_result_area(result.get("invention_content", ""))
                        
                    with tab2:
                        st.markdown("#### 现有技术背景")
                        show_result_area(result.get("background", ""))
                        
                    with tab3:
                        st.markdown("#### 具体实施方案详解")
                        show_result_area(result.get("embodiments", ""))
                        
                else:
                    st.error(f"❌ 生成失败，服务器返回错误代码: {response.status_code}")
                    with st.expander("查看调试信息"):
                        st.json(response.json())
                    
            except Exception as e:
                st.error("❌ 连接服务器失败，请检查网络或后端服务。")
                st.error(f"错误详情: {str(e)}")
